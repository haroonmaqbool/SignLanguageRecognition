<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Language Recognition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: linear-gradient(135deg, #0a1f1a 0%, #0d2818 50%, #061612 100%);
            overflow: hidden;
        }
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 40px 20px;
        }
        .landing-page h1 {
            font-size: 4.5rem;
            font-weight: 900;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .try-now-btn {
            padding: 22px 70px;
            font-size: 1.4rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            margin-top: 40px;
        }
        .app-page {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .app-page.active { display: block; }
        .camera-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            background: #18181b;
            margin-bottom: 25px;
        }
        #video, #displayCanvas {
            width: 100%;
            height: auto;
            display: block;
            min-height: 400px;
        }
        .prediction-box {
            background: rgba(39, 39, 42, 0.5);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .current-letter {
            font-size: 5rem;
            font-weight: 800;
            color: #10b981;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div id="landingPage" class="landing-page">
        <h1>Sign Language Recognition</h1>
        <p style="font-size: 1.5rem; margin-bottom: 20px; color: #9ca3af;">
            Transform hand gestures into text in real-time using AI-powered deep learning
        </p>
        <p style="font-size: 1rem; color: #6b7280; margin-bottom: 40px;">
            Team: Haroon, Saria, Azmeer | COMP-360 | Forman Christian College
        </p>
        <button class="try-now-btn" onclick="showApp()">Try Now ‚Üí</button>
    </div>
    <div id="appPage" class="app-page">
        <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
            <button onclick="showLanding()" style="padding: 12px 30px; background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; border-radius: 25px; cursor: pointer;">‚Üê Back</button>
            <h2 style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Real-Time Detection Studio</h2>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 30px;">
            <div style="background: rgba(39, 39, 42, 0.5); border-radius: 20px; padding: 30px;">
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="displayCanvas" style="display: none;"></canvas>
                </div>
                <div style="text-align: center; margin: 25px 0;">
                    <label style="color: #9ca3af; margin-right: 15px;">AI Model:</label>
                    <select id="modelSelect" style="padding: 12px 25px; background: rgba(39, 39, 42, 0.8); color: #e4e4e7; border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 25px;">
                        {% for model in available_models %}
                        <option value="{{ model }}" {% if model == current_model %}selected{% endif %}>{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="startCamera()" style="padding: 14px 35px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 25px; cursor: pointer;">‚ñ∂ Start</button>
                    <button onclick="stopCamera()" style="padding: 14px 35px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 25px; cursor: pointer;">‚èπ Stop</button>
                    <button onclick="clearSentence()" style="padding: 14px 35px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 25px; cursor: pointer;">üóë Clear</button>
                </div>
            </div>
            <div>
                <div class="prediction-box">
                    <h3 style="font-size: 1rem; color: #9ca3af; margin-bottom: 15px;">Current Gesture</h3>
                    <div class="current-letter" id="currentLetter">-</div>
                    <div id="confidence" style="font-size: 1.1rem; color: #6b7280;">Confidence: 0%</div>
                </div>
                <div class="prediction-box">
                    <h3 style="font-size: 1rem; color: #9ca3af; margin-bottom: 20px;">Generated Text</h3>
                    <div id="sentenceDisplay" style="font-size: 1.8rem; color: #e4e4e7; min-height: 100px; margin-bottom: 20px;">Start making gestures...</div>
                    <button id="ttsButton" onclick="speakText()" disabled style="padding: 14px 35px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 25px; cursor: pointer;">üîä Speak Text</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let video = document.getElementById('video');
        let displayCanvas = document.getElementById('displayCanvas');
        let displayCtx = displayCanvas.getContext('2d');
        let currentSentence = '';
        let stream = null;
        let predictionInterval = null;
        let lastPrediction = '';
        let predictionCount = 0;
        let currentAudio = null;
        
        function showApp() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('appPage').classList.add('active');
        }
        function showLanding() {
            document.getElementById('appPage').classList.remove('active');
            document.getElementById('landingPage').style.display = 'flex';
            stopCamera();
        }
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    displayCanvas.width = video.videoWidth;
                    displayCanvas.height = video.videoHeight;
                    video.style.display = 'none';
                    displayCanvas.style.display = 'block';
                    startPredictionLoop();
                };
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        }
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
            }
            if (predictionInterval) {
                clearInterval(predictionInterval);
                predictionInterval = null;
            }
            video.style.display = 'block';
            displayCanvas.style.display = 'none';
        }
        function clearSentence() {
            currentSentence = '';
            lastPrediction = '';
            predictionCount = 0;
            document.getElementById('sentenceDisplay').textContent = 'Start making gestures...';
            document.getElementById('ttsButton').disabled = true;
        }
        function startPredictionLoop() {
            if (predictionInterval) clearInterval(predictionInterval);
            predictionInterval = setInterval(async () => {
                if (!stream) return;
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('image', blob, 'frame.jpg');
                    formData.append('model', document.getElementById('modelSelect').value);
                    formData.append('draw_landmarks', 'true');
                    try {
                        const response = await fetch('/predict', { method: 'POST', body: formData });
                        const data = await response.json();
                        if (data.image_with_landmarks) {
                            const img = new Image();
                            img.onload = () => {
                                displayCtx.drawImage(img, 0, 0, displayCanvas.width, displayCanvas.height);
                            };
                            img.src = 'data:image/jpeg;base64,' + data.image_with_landmarks;
                        }
                        if (data.prediction) {
                            // Display "SPACE" for space gestures, otherwise show the letter
                            const displayText = (data.is_space || data.prediction === ' ') ? 'SPACE' : data.prediction;
                            document.getElementById('currentLetter').textContent = displayText;
                            const confidencePercent = (data.confidence * 100).toFixed(1);
                            document.getElementById('confidence').textContent = `Confidence: ${confidencePercent}%`;
                            if (data.confidence > 0.7) {
                                if (data.prediction === lastPrediction) {
                                    predictionCount++;
                                    if (predictionCount >= 3) {
                                        currentSentence += data.prediction;
                                        document.getElementById('sentenceDisplay').textContent = currentSentence;
                                        document.getElementById('ttsButton').disabled = false;
                                        predictionCount = 0;
                                        lastPrediction = '';
                                    }
                                } else {
                                    lastPrediction = data.prediction;
                                    predictionCount = 1;
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Prediction error:', err);
                    }
                }, 'image/jpeg');
            }, 200);
        }
        async function speakText() {
            const text = currentSentence.trim();
            if (!text) return;
            const ttsButton = document.getElementById('ttsButton');
            ttsButton.disabled = true;
            try {
                const response = await fetch('/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                const data = await response.json();
                if (data.success) {
                    const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], { type: 'audio/mpeg' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    currentAudio = new Audio(audioUrl);
                    currentAudio.onended = () => {
                        ttsButton.disabled = false;
                        URL.revokeObjectURL(audioUrl);
                    };
                    await currentAudio.play();
                }
            } catch (err) {
                console.error('TTS error:', err);
            } finally {
                ttsButton.disabled = false;
            }
        }
        document.getElementById('modelSelect').addEventListener('change', (e) => {
            fetch('/set_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: e.target.value })
            });
        });
    </script>
</body>
</html>